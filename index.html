<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D&D Sim - Ultimate</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #ccc; margin: 0; padding-bottom: 50px; }
        .nav { background: #0f0f0f; display: flex; border-bottom: 2px solid #333; }
        .nav div { padding: 15px 20px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px;}
        .nav div.active { color: #e67e22; border-bottom: 4px solid #e67e22; }
        .content { max-width: 1200px; margin: 20px auto; display: none; padding: 0 20px; }
        .content.active { display: block; }

        h2 { color: #e67e22; border-bottom: 1px solid #444; }
        h3 { color: #3498db; font-size: 0.9rem; text-transform: uppercase; margin-top: 20px; }

        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        input, select { width: 100%; padding: 8px; background: #252525; border: 1px solid #444; color: white; border-radius: 4px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; background: #1a1a1a; padding: 10px; border-radius: 5px; }
        .stat-box input { text-align: center; font-weight: bold; color: #e67e22; }

        .feat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; height: 150px; overflow-y: auto; border: 1px solid #333; padding: 5px;}
        .feat-item { background: #222; padding: 5px; font-size: 0.85rem; display: flex; gap: 5px; align-items: center; cursor: pointer; }
        .feat-item:hover { background: #333; }

        .btn { background: #e67e22; color: white; border: none; padding: 12px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn:hover { background: #d35400; }

        .effect-box { background: #2c3e50; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; }

        .card-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 20px; }
        .card { background: #202020; padding: 10px; border-left: 3px solid #555; font-size: 0.9rem; }
        
        #results { text-align: center; padding: 30px; background: #1a1a1a; margin-top: 20px; border: 1px solid #e67e22; display: none; }
    </style>
</head>
<body>

<div class="nav">
    <div onclick="nav('tab-actions')" class="active">1. Créateur Sorts & Effets</div>
    <div onclick="nav('tab-pj')">2. Héros (PJ)</div>
    <div onclick="nav('tab-monstre')">3. Monstres</div>
    <div onclick="nav('tab-simu')">4. Simulation</div>
</div>

<!-- ACTIONS -->
<div id="tab-actions" class="content active">
    <h2>Créer Sort / Arme</h2>
    <div class="row">
        <div class="col"><label>Nom</label><input id="act_nom" placeholder="Ex: Bénédiction"></div>
        <div class="col"><label>Niveau</label><input type="number" id="act_lvl" value="1"></div>
        <div class="col"><label>Type</label>
            <select id="act_type" onchange="uiEffect()">
                <option value="attaque">Attaque</option>
                <option value="save">Sauvegarde</option>
                <option value="soin">Soin / Buff</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col"><label>Dégâts / Soin (Ex: 1d8)</label><input id="act_dice"></div>
        <div class="col" id="save_col" style="display:none"><label>Stat Save</label>
            <select id="act_save"><option value="dex">DEX</option><option value="con">CON</option><option value="wis">WIS</option></select>
        </div>
    </div>

    <div style="margin-top:10px;">
        <label><input type="checkbox" id="has_effect" onchange="uiEffect()"> Ajouter un Effet Spécial (Buff/Condition)</label>
    </div>
    
    <div id="effect_config" class="effect-box">
        <div class="row">
            <div class="col"><label>Type d'Effet</label>
                <select id="eff_type">
                    <option value="buff_atk">Bonus Attaque (Bless)</option>
                    <option value="buff_ac">Bonus CA (Haste/Shield)</option>
                    <option value="prone">Mettre à Terre (Prone)</option>
                    <option value="blinded">Aveugler</option>
                    <option value="paralyzed">Paralyser</option>
                </select>
            </div>
            <div class="col"><label>Cible</label>
                <select id="eff_target">
                    <option value="self">Soi-même / Allié</option>
                    <option value="enemy">Ennemi (Debuff)</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col"><label>Valeur (ex: 1d4 ou 2)</label><input id="eff_val" placeholder="1d4"></div>
            <div class="col"><label>Durée (Tours)</label><input type="number" id="eff_dur" value="10"></div>
            <div class="col" style="padding-top:20px"><label><input type="checkbox" id="eff_conc"> Concentration ?</label></div>
        </div>
    </div>

    <button class="btn" onclick="addAct()">Créer</button>
    <div id="list-act" class="card-list"></div>
</div>

<!-- PJ -->
<div id="tab-pj" class="content">
    <h2>Créer PJ</h2>
    <div class="row">
        <div class="col"><input id="pj_nom" value="Guerrier"></div>
        <div class="col"><select id="pj_class"><option value="Guerrier">Guerrier</option><option value="Magicien">Magicien</option><option value="Clerc">Clerc</option><option value="Barbare">Barbare</option><option value="Paladin">Paladin</option></select></div>
        <div class="col"><input type="number" id="pj_lvl" value="5"></div>
    </div>
    <div class="row">
        <div class="col"><label>Position</label><select id="pj_pos"><option value="front">Frontline (CaC)</option><option value="back">Backline (Distance)</option></select></div>
    </div>
    <div class="stat-grid" id="pj_stats"></div>
    
    <h3>Dons (Feats)</h3>
    <div class="feat-grid">
        <label class="feat-item"><input type="checkbox" class="pj-feat" value="Great Weapon Master"> Great Weapon Master (-5/+10)</label>
        <label class="feat-item"><input type="checkbox" class="pj-feat" value="Sharpshooter"> Sharpshooter (-5/+10)</label>
        <label class="feat-item"><input type="checkbox" class="pj-feat" value="Reckless Attack"> Reckless Attack (Advantage)</label>
        <label class="feat-item"><input type="checkbox" class="pj-feat" value="War Caster"> War Caster</label>
    </div>

    <h3>Actions Connues</h3>
    <div id="pj_act_chk" class="feat-grid"></div>
    
    <div class="row" style="margin-top:10px"><div class="col"><label>PV</label><input id="pj_hp"></div><div class="col"><label>CA</label><input id="pj_ac" value="16"></div></div>
    <button class="btn" onclick="addF('PJ')">Sauvegarder</button>
    <div id="list-pj" class="card-list"></div>
</div>

<!-- MONSTRE -->
<div id="tab-monstre" class="content">
    <h2>Monstre</h2>
    <div class="row"><div class="col"><input id="m_nom" value="Orc"></div><div class="col"><input id="m_lvl" value="1"></div></div>
    <div class="row"><div class="col"><select id="m_pos"><option value="front">Frontline</option><option value="back">Backline</option></select></div></div>
    <div class="stat-grid" id="m_stats"></div>
    <div id="m_act_chk" class="feat-grid" style="margin-top:10px"></div>
    <div class="row" style="margin-top:10px"><div class="col"><input id="m_hp" value="15"></div><div class="col"><input id="m_ac" value="13"></div></div>
    <button class="btn" onclick="addF('MONSTRE')">Sauvegarder</button>
    <div id="list-m" class="card-list"></div>
</div>

<!-- SIMULATION -->
<div id="tab-simu" class="content">
    <h2>Arène</h2>
    <div class="row">
        <div class="col"><h3>Groupe</h3><div id="sim_pj" class="feat-grid"></div></div>
        <div class="col"><h3>Ennemis</h3><div id="sim_m" class="feat-grid"></div></div>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <input type="number" id="iter" value="1000" style="width:100px;"> combats
        <button class="btn" onclick="runSim()">LANCER</button>
    </div>
    <div id="results">
        <h1 id="res_win" style="color:#e67e22; font-size:3rem;">--%</h1>
        <p>Victoire</p>
    </div>
</div>

<script>
    const STATS = ['str','dex','con','int','wis','cha'];
    function nav(id) {
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav div').forEach(d=>d.classList.remove('active'));
        document.getElementById(id).classList.add('active'); event.target.classList.add('active');
        if(id==='tab-actions') loadActs();
        if(id==='tab-pj') { renderStats('pj'); loadChk('pj_act_chk'); loadList('PJ','list-pj'); }
        if(id==='tab-monstre') { renderStats('m'); loadChk('m_act_chk'); loadList('MONSTRE','list-m'); }
        if(id==='tab-simu') loadSimChk();
    }
    function uiEffect() {
        const type = document.getElementById('act_type').value;
        document.getElementById('save_col').style.display = (type==='save'?'block':'none');
        document.getElementById('effect_config').style.display = document.getElementById('has_effect').checked ? 'block' : 'none';
    }
    function renderStats(p) {
        const d = document.getElementById(p+'_stats'); if(d.innerHTML) return;
        STATS.forEach(s=>d.innerHTML+=`<div class="stat-box"><label>${s.toUpperCase()}</label><input type="number" id="${p}_${s}" value="10"></div>`);
    }
    async function addAct() {
        let eff = null;
        if(document.getElementById('has_effect').checked) {
            eff = JSON.stringify({
                type: document.getElementById('eff_type').value,
                target: document.getElementById('eff_target').value,
                val: document.getElementById('eff_val').value,
                duration: parseInt(document.getElementById('eff_dur').value),
                conc: document.getElementById('eff_conc').checked
            });
        }
        const data = {
            nom: document.getElementById('act_nom').value, formule: document.getElementById('act_dice').value,
            type_action: document.getElementById('act_type').value, level: parseInt(document.getElementById('act_lvl').value),
            save_stat: document.getElementById('act_save').value, effect_json: eff
        };
        await fetch('/api/action/add', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        loadActs();
    }
    async function loadActs() {
        const d = await (await fetch('/api/action/list')).json();
        document.getElementById('list-act').innerHTML = d.map(a=>`<div class="card"><b>${a.nom}</b> (Niv ${a.level})</div>`).join('');
    }
    async function loadChk(id) {
        const d = await (await fetch('/api/action/list')).json();
        document.getElementById(id).innerHTML = d.map(a=>`<label class="feat-item"><input type="checkbox" value="${a.id}"> ${a.nom}</label>`).join('');
    }
    async function addF(type) {
        const p = type==='PJ'?'pj':'m';
        const s={}; STATS.forEach(k=>s[k]=parseInt(document.getElementById(`${p}_${k}`).value));
        const acts=Array.from(document.getElementById(`${p}_act_chk`).querySelectorAll('input:checked')).map(c=>parseInt(c.value));
        
        let feats = [];
        if(p==='pj') feats=Array.from(document.querySelectorAll('.pj-feat:checked')).map(c=>c.value);

        const data = {
            nom: document.getElementById(`${p}_nom`).value, type_entite:type, classe: 'Guerrier', niveau: 5,
            stats:s, hp_max:parseInt(document.getElementById(`${p}_hp`).value)||20, ac:parseInt(document.getElementById(`${p}_ac`).value)||10,
            actions_ids: acts, features: feats, position: document.getElementById(`${p}_pos`).value
        };
        await fetch('/api/fighter/add', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        loadList(type, type==='PJ'?'list-pj':'list-m');
    }
    async function loadList(type, target) {
        const d = await (await fetch(`/api/fighter/list?type=${type}`)).json();
        document.getElementById(target).innerHTML = d.map(f=>`<div class="card"><b>${f.nom}</b> (${f.position})</div>`).join('');
    }
    async function loadSimChk() {
        let d = await (await fetch('/api/fighter/list?type=PJ')).json();
        document.getElementById('sim_pj').innerHTML = d.map(f=>`<label class="feat-item"><input type="checkbox" value="${f.id}">${f.nom}</label>`).join('');
        d = await (await fetch('/api/fighter/list?type=MONSTRE')).json();
        document.getElementById('sim_m').innerHTML = d.map(f=>`<label class="feat-item"><input type="checkbox" value="${f.id}">${f.nom}</label>`).join('');
    }
    async function runSim() {
        const p = Array.from(document.getElementById('sim_pj').querySelectorAll('input:checked')).map(c=>parseInt(c.value));
        const m = Array.from(document.getElementById('sim_m').querySelectorAll('input:checked')).map(c=>parseInt(c.value));
        const r = await (await fetch('/api/simulate', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({iterations:parseInt(document.getElementById('iter').value), pj_ids:p, monstre_ids:m})})).json();
        document.getElementById('results').style.display='block';
        document.getElementById('res_win').innerText = r.win_rate.toFixed(1)+'%';
    }
    nav('tab-actions');
</script>
</body>
</html>