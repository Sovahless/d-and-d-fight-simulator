<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecte du Destin - D&D Sim</title>
    
    <!-- 1. LIBRAIRIES EXTERNES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 2. POLICES D'√âCRITURE IMMERSIVES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- 3. CONFIGURATION TAILWIND & STYLE -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fantasy': ['Cinzel', 'serif'], 'body': ['Lato', 'sans-serif'] },
                    colors: { 
                        'dnd-dark': '#0b0c10', 
                        'dnd-panel': '#1f2833',
                        'dnd-gold': '#c5a059', 
                        'dnd-red': '#c0392b', 
                        'dnd-blue': '#2980b9' 
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0b0c10; 
            background-image: radial-gradient(circle at 50% 0, #1f2833, #0b0c10); 
            color: #c1c8e4; 
        }
        
        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0b0c10; }
        ::-webkit-scrollbar-thumb { background: #45a29e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #66fcf1; }

        /* Styles UI RPG */
        .rpg-panel {
            background: rgba(31, 40, 51, 0.95);
            border: 1px solid #45a29e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            border-radius: 0.5rem;
            position: relative;
        }
        
        .rpg-input {
            background: #0b0c10;
            border: 1px solid #2c3e50;
            color: #e0e0e0;
            transition: all 0.3s ease;
            font-family: 'Lato', sans-serif;
        }
        .rpg-input:focus {
            border-color: #c5a059;
            box-shadow: 0 0 8px rgba(197, 160, 89, 0.2);
            outline: none;
        }

        .nav-item.active {
            border-left: 3px solid #66fcf1;
            color: #66fcf1;
            background: linear-gradient(90deg, rgba(69, 162, 158, 0.15), transparent);
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .search-result {
            padding: 8px; border-bottom: 1px solid #333; cursor: pointer; transition: background 0.2s;
        }
        .search-result:hover { background: #45a29e; color: #0b0c10; font-weight: bold; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-body selection:bg-dnd-red selection:text-white">

    <!-- BARRE LAT√âRALE -->
    <div class="w-72 bg-black/80 backdrop-blur-md border-r border-gray-800 flex flex-col z-20 shadow-2xl relative">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/leather.png')] opacity-20 pointer-events-none"></div>
        
        <div class="p-8 text-center border-b border-gray-800 relative z-10">
            <h1 class="text-3xl font-fantasy font-bold text-transparent bg-clip-text bg-gradient-to-b from-dnd-gold to-yellow-800 drop-shadow-sm">
                <i class="fas fa-dragon mr-2"></i>Simulacrum
            </h1>
            <p class="text-xs text-gray-500 mt-2 font-fantasy tracking-widest uppercase">V9.0 Ultimate</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 relative z-10 overflow-y-auto">
            <button onclick="nav('tab-actions')" id="nav-act" class="nav-item w-full text-left px-6 py-4 rounded mb-2 flex items-center group hover:bg-white/5 transition-all">
                <i class="fas fa-scroll w-6 group-hover:text-dnd-gold"></i> <span class="font-bold ml-2">Grimoire</span>
            </button>
            <button onclick="nav('tab-pj')" id="nav-pj" class="nav-item w-full text-left px-6 py-4 rounded mb-2 flex items-center group hover:bg-white/5 transition-all">
                <i class="fas fa-helmet-safety w-6 group-hover:text-blue-400"></i> <span class="font-bold ml-2">H√©ros (PJ)</span>
            </button>
            <button onclick="nav('tab-monstre')" id="nav-mon" class="nav-item w-full text-left px-6 py-4 rounded mb-2 flex items-center group hover:bg-white/5 transition-all">
                <i class="fas fa-skull-crossbones w-6 group-hover:text-red-500"></i> <span class="font-bold ml-2">Bestiaire</span>
            </button>
            <button onclick="nav('tab-simu')" id="nav-sim" class="nav-item w-full text-left px-6 py-4 rounded mb-2 flex items-center group hover:bg-white/5 transition-all">
                <i class="fas fa-dice-d20 w-6 group-hover:text-purple-400"></i> <span class="font-bold ml-2">Ar√®ne</span>
            </button>
        </nav>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <div class="flex-1 overflow-y-auto p-8 relative">
        
        <!-- 1. ONGLET ACTIONS & SORTS -->
        <div id="tab-actions" class="content hidden fade-in max-w-6xl mx-auto">
            <div class="flex items-center justify-between mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-4xl font-fantasy text-dnd-gold">Forge Arcanique</h2>
                <button onclick="toggleSearch('spell_search_box')" class="bg-purple-900/40 text-purple-300 px-4 py-2 rounded border border-purple-500/50 hover:bg-purple-800 transition font-fantasy text-sm">
                    <i class="fas fa-search mr-2"></i> Import Open5e
                </button>
            </div>
            
            <!-- Moteur de Recherche de Sorts -->
            <div id="spell_search_box" class="hidden mb-6 bg-black p-4 rounded border border-purple-500 shadow-glow">
                <div class="flex gap-2">
                    <input id="spell_query" class="rpg-input w-full p-2 rounded" placeholder="Nom anglais du sort (ex: Fireball)..." onkeyup="if(event.key==='Enter') searchSpells()">
                    <button onclick="searchSpells()" class="bg-purple-600 px-6 rounded text-white font-bold hover:bg-purple-500">Chercher</button>
                </div>
                <div id="spell_results" class="mt-2 max-h-60 overflow-y-auto bg-gray-900 border border-gray-700 hidden rounded"></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Formulaire d'√©dition -->
                <div class="lg:col-span-5 rpg-panel p-6 h-fit sticky top-4">
                    <input type="hidden" id="act_id"> <!-- ID cach√© pour le mode √©dition -->
                    
                    <div class="space-y-5">
                        <div>
                            <label class="text-xs font-bold text-dnd-gold uppercase tracking-wider">Nom de l'Action</label>
                            <input id="act_nom" class="rpg-input w-full p-2 rounded text-lg font-bold text-white placeholder-gray-700" placeholder="Ex: √âp√©e Longue">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Ma√Ætrise (Mastery)</label>
                            <select id="act_mastery" class="rpg-input w-full p-2 rounded text-sm">
                                <option value="">(Aucune)</option>
                                <option value="Graze">Graze</option>
                                <option value="Vex">Vex</option>
                                <option value="Nick">Nick</option>
                                <option value="Topple">Topple</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">Niveau (0=Atk)</label>
                                <input type="number" id="act_lvl" value="0" class="rpg-input w-full p-2 rounded text-center">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">D√©g√¢ts / Soin</label>
                                <input id="act_dice" class="rpg-input w-full p-2 rounded font-mono text-yellow-500" placeholder="1d8+3">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Type d'Action</label>
                            <select id="act_type" onchange="uiEff()" class="rpg-input w-full p-2 rounded">
                                <option value="attaque">‚öîÔ∏è Attaque (vs CA)</option>
                                <option value="save">üõ°Ô∏è Sauvegarde (vs DC)</option>
                                <option value="soin">üíñ Soin / Buff</option>
                            </select>
                        </div>
                        
                        <!-- Configuration Sauvegarde -->
                        <div id="save_ui" class="hidden bg-black/30 p-3 rounded border border-dashed border-gray-600">
                            <label class="text-xs font-bold text-blue-400 uppercase">Statistique Cible</label>
                            <select id="act_save" class="rpg-input w-full p-1 text-sm rounded">
                                <option value="dex">Dext√©rit√© (Explosions)</option>
                                <option value="con">Constitution (Poison)</option>
                                <option value="wis">Sagesse (Mental)</option>
                                <option value="str">Force</option>
                            </select>
                        </div>
                        
                        <!-- Toggle Effets -->
                        <div class="pt-2">
                            <label class="flex items-center cursor-pointer group select-none">
                                <input type="checkbox" id="has_eff" onchange="uiEff()" class="w-4 h-4 bg-gray-900 border-gray-600 rounded text-dnd-gold focus:ring-0">
                                <span class="ml-2 text-sm text-gray-300 group-hover:text-white transition-colors">Ajouter un Effet Sp√©cial</span>
                            </label>
                        </div>

                        <!-- Configuration Effets -->
                        <div id="eff_ui" class="hidden bg-purple-900/20 p-4 rounded border border-purple-500/30 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <select id="eff_type" class="rpg-input w-full text-sm p-1 rounded">
                                    <option value="buff_atk">Buff Attaque</option>
                                    <option value="buff_ac">Buff CA</option>
                                    <option value="prone">√âtat: √Ä terre</option>
                                    <option value="blinded">√âtat: Aveugl√©</option>
                                </select>
                                <select id="eff_tgt" class="rpg-input w-full text-sm p-1 rounded">
                                    <option value="self">Sur Soi / Alli√©</option>
                                    <option value="enemy">Sur Ennemi</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <input id="eff_val" placeholder="1d4" class="rpg-input w-full text-sm p-1 rounded text-center">
                                <input type="number" id="eff_dur" value="10" class="rpg-input w-full text-sm p-1 rounded text-center" title="Dur√©e (tours)">
                                <label class="flex items-center justify-center text-xs text-purple-300 border border-purple-500/30 rounded bg-black/20 cursor-pointer">
                                    <input type="checkbox" id="eff_conc" class="mr-1"> Conc.
                                </label>
                            </div>
                        </div>

                        <!-- Boutons Action -->
                        <div class="flex gap-3 pt-4">
                            <button id="btn_cancel_act" onclick="resetForm('act')" class="hidden w-1/3 bg-gray-700 hover:bg-gray-600 text-white rounded font-fantasy transition-colors">Annuler</button>
                            <button id="btn_save_act" onclick="saveAct()" class="flex-1 bg-gradient-to-r from-dnd-red to-purple-900 hover:from-dnd-red hover:to-purple-700 text-white text-lg py-2 rounded shadow-lg font-fantasy tracking-wider transition-transform transform hover:scale-[1.02]">
                                Inscrire le Sort
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des Actions -->
                <div class="lg:col-span-7">
                    <div id="list-act" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- Rempli par JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ONGLET PERSONNAGES (PJ) -->
        <div id="tab-pj" class="content hidden fade-in max-w-6xl mx-auto">
            <h2 class="text-4xl font-fantasy text-blue-400 mb-8 border-b border-gray-800 pb-4">Hall des H√©ros</h2>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 rpg-panel p-6 h-fit sticky top-4 border-blue-500/30">
                    <input type="hidden" id="pj_id">
                    <div class="space-y-4">
                        <input id="pj_nom" class="rpg-input w-full p-3 text-xl font-bold text-blue-100 bg-blue-900/10 border-blue-500/50 rounded" placeholder="Nom du H√©ros">
                        
                        <div class="flex gap-2">
                            <select id="pj_cls" class="rpg-input flex-1 p-2 rounded">
                                <option value="Guerrier">Guerrier</option><option value="Mage">Magicien</option><option value="Paladin">Paladin</option><option value="Clerc">Clerc</option><option value="Barbare">Barbare</option><option value="Roublard">Roublard</option>
                            </select>
                            <input type="number" id="pj_lvl" value="5" class="rpg-input w-20 text-center p-2 rounded font-bold text-blue-400" title="Niveau">
                        </div>
                        
                        <select id="pj_pos" class="rpg-input w-full p-2 rounded text-sm text-gray-400">
                            <option value="front">üõ°Ô∏è Frontline (Corps-√†-corps)</option>
                            <option value="back">üèπ Backline (Distance)</option>
                        </select>
                        
                        <div class="grid grid-cols-6 gap-1 bg-black/40 p-3 rounded border border-gray-700" id="pj_stats"></div>
                        
                        <div class="border-t border-gray-700 pt-3">
                            <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">Dons & Ma√Ætrises</p>
                            <div class="flex flex-wrap gap-2">
                                <label class="cursor-pointer text-xs"><input type="checkbox" class="pj-feat hidden" value="Great Weapon Master"><span class="px-2 py-1 border border-gray-600 rounded text-gray-400 hover:border-gray-300">GWM</span></label>
                                <label class="cursor-pointer text-xs"><input type="checkbox" class="pj-feat hidden" value="Sharpshooter"><span class="px-2 py-1 border border-gray-600 rounded text-gray-400 hover:border-gray-300">Sharp</span></label>
                                <label class="cursor-pointer text-xs"><input type="checkbox" class="pj-feat hidden" value="War Caster"><span class="px-2 py-1 border border-gray-600 rounded text-gray-400 hover:border-gray-300">WarCast</span></label>
                                <label class="cursor-pointer text-xs"><input type="checkbox" class="pj-feat hidden" value="Reckless Attack"><span class="px-2 py-1 border border-gray-600 rounded text-gray-400 hover:border-gray-300">Reckless</span></label>
                            </div>
                        </div>
                        
                        <div class="h-40 overflow-y-auto bg-black/20 p-2 rounded border border-gray-700">
                            <p class="text-[10px] font-bold text-gray-500 uppercase mb-2 sticky top-0 bg-[#16191d] py-1 z-10">Actions Connues</p>
                            <div id="pj_act_chk" class="space-y-1"></div>
                        </div>

                        <div class="flex gap-4">
                            <input id="pj_hp" placeholder="PV Max" class="rpg-input w-1/2 p-2 text-center font-bold text-red-400">
                            <input id="pj_ac" placeholder="CA" class="rpg-input w-1/2 p-2 text-center font-bold text-gray-300">
                        </div>
                        
                        <div class="flex gap-2 pt-2">
                            <button id="btn_cancel_pj" onclick="resetForm('pj')" class="hidden w-1/3 bg-gray-700 text-white rounded font-fantasy">Retour</button>
                            <button id="btn_save_pj" onclick="saveF('PJ')" class="flex-1 bg-blue-700 hover:bg-blue-600 border border-blue-500 text-white font-fantasy py-2 rounded shadow-lg transition-all">Enr√¥ler le H√©ros</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-7" id="list-pj"></div>
            </div>
        </div>

        <!-- 3. ONGLET MONSTRES -->
        <div id="tab-monstre" class="content hidden fade-in max-w-6xl mx-auto">
            <div class="flex items-center justify-between mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-4xl font-fantasy text-dnd-red">Antre des Monstres</h2>
                <button onclick="toggleSearch('mon_search_box')" class="bg-red-900/40 text-red-300 px-4 py-2 rounded border border-red-500/50 hover:bg-red-800 transition font-fantasy text-sm">
                    <i class="fas fa-search mr-2"></i> Bestiaire Open5e
                </button>
            </div>

            <!-- Recherche Monstre Open5e -->
            <div id="mon_search_box" class="hidden mb-6 bg-black p-4 rounded border border-red-500 shadow-glow-red">
                <div class="flex gap-2">
                    <input id="mon_query" class="rpg-input w-full p-2 rounded" placeholder="Nom du monstre (en anglais, ex: Goblin)..." onkeyup="if(event.key==='Enter') searchMonster()">
                    <button onclick="searchMonster()" class="bg-red-700 px-6 rounded text-white font-bold hover:bg-red-600">Chercher</button>
                </div>
                <div id="mon_results" class="mt-2 max-h-60 overflow-y-auto bg-gray-900 border border-gray-700 hidden rounded"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 rpg-panel p-6 h-fit sticky top-4 border-red-900/50">
                    <input type="hidden" id="m_id">
                    <div class="space-y-4">
                        <input id="m_nom" class="rpg-input w-full p-3 text-xl font-bold text-red-100 bg-red-900/10 border-red-500/50 rounded" placeholder="Nom de la Cr√©ature">
                        
                        <div class="flex gap-2">
                            <input id="m_lvl" class="rpg-input w-20 text-center p-2 rounded" placeholder="CR">
                            <select id="m_beh" class="rpg-input flex-1 p-2 rounded text-red-300">
                                <option value="random">üß† B√™te (Al√©atoire)</option>
                                <option value="focus_low_hp">ü©∏ Pr√©dateur (Focus Low HP)</option>
                                <option value="focus_backline">üó°Ô∏è Assassin (Focus Arri√®re)</option>
                            </select>
                        </div>
                        <select id="m_pos" class="rpg-input w-full p-2 rounded"><option value="front">Frontline</option><option value="back">Backline</option></select>

                        <div class="grid grid-cols-6 gap-1 bg-black/40 p-3 rounded border border-gray-700" id="m_stats"></div>
                        <div class="h-32 overflow-y-auto bg-black/20 p-2 rounded border border-gray-700"><div id="m_act_chk" class="space-y-1"></div></div>
                        
                        <div class="flex gap-4">
                            <input id="m_hp" placeholder="PV" class="rpg-input w-1/2 p-2 text-center font-bold text-red-500">
                            <input id="m_ac" placeholder="CA" class="rpg-input w-1/2 p-2 text-center font-bold">
                        </div>
                        
                        <div class="flex gap-2 pt-2">
                            <button id="btn_cancel_m" onclick="resetForm('m')" class="hidden w-1/3 bg-gray-700 text-white rounded font-fantasy">Retour</button>
                            <button id="btn_save_m" onclick="saveF('MONSTRE')" class="flex-1 bg-red-800 hover:bg-red-700 border border-red-600 text-white font-fantasy py-2 rounded shadow-glow transition-all">Invoquer</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-7" id="list-m"></div>
            </div>
        </div>

        <!-- 4. ONGLET SIMULATION -->
        <div id="tab-simu" class="content hidden fade-in max-w-7xl mx-auto h-full pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
                <!-- Configuration -->
                <div class="lg:col-span-1 rpg-panel p-5 flex flex-col h-[80vh]">
                    <h3 class="text-dnd-blue font-fantasy text-xl mb-4 border-b border-gray-700 pb-2">Forces du Bien</h3>
                    <div id="sim_pj" class="flex-1 overflow-y-auto bg-black/20 p-2 rounded mb-4 border border-gray-800 custom-scroll"></div>
                    
                    <h3 class="text-dnd-red font-fantasy text-xl mb-4 border-b border-gray-700 pb-2">Forces du Mal</h3>
                    <div id="sim_m" class="flex-1 overflow-y-auto bg-black/20 p-2 rounded mb-4 border border-gray-800 custom-scroll"></div>
                    
                    <div class="mt-auto pt-4 border-t border-gray-700 flex items-center gap-3">
                        <div class="relative">
                            <input id="iter" value="1000" class="rpg-input w-24 text-center p-3 rounded font-bold text-lg">
                            <span class="absolute -top-2 left-2 bg-[#1f2833] text-[10px] px-1 text-gray-500 uppercase">Simulations</span>
                        </div>
                        <button onclick="runSim()" class="flex-1 bg-green-700 hover:bg-green-600 text-white font-fantasy text-xl py-3 rounded shadow-lg hover:shadow-glow transition-all border border-green-500">
                            COMBATTRE !
                        </button>
                    </div>
                </div>

                <!-- R√©sultats -->
                <div class="lg:col-span-2 flex flex-col gap-6 h-[80vh]">
                    <!-- Panneau Stats -->
                    <div id="res_panel" class="hidden bg-gradient-to-r from-[#1f2833] to-[#111] p-6 rounded-lg border border-dnd-gold flex justify-between items-center shadow-glow relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-dnd-gold"></div>
                        <div class="text-center z-10">
                            <p class="text-gray-400 text-sm font-fantasy tracking-widest mb-2">TAUX DE VICTOIRE H√âRO√èQUE</p>
                            <h1 id="res_win" class="text-6xl font-fantasy font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 drop-shadow-lg">--%</h1>
                        </div>
                        <div class="h-40 w-40 z-10">
                            <canvas id="dmgChart"></canvas>
                        </div>
                    </div>

                    <!-- Journal de Combat -->
                    <div class="flex-1 bg-[#0a0a0a] p-4 rounded-lg border border-gray-800 font-mono text-sm text-green-500 overflow-y-auto shadow-inner relative" id="log_area">
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-700 text-center">
                            <i class="fas fa-book-dead text-4xl mb-2"></i>
                            <p>En attente de donn√©es de combat...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION FLOTTANTE -->
    <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 border border-dnd-gold text-dnd-gold px-6 py-4 rounded shadow-2xl transform translate-y-20 opacity-0 transition-all duration-500 z-50 flex items-center gap-3 font-fantasy">
        <i class="fas fa-check-circle text-xl"></i>
        <span id="toast-msg">Op√©ration r√©ussie</span>
    </div>

    <script>
        // --- CONFIGURATION & VARIABLES ---
        const STATS = ['str','dex','con','int','wis','cha'];
        let myChart = null;
        // API Proxy pour √©viter CORS si possible, sinon direct
        const API_MONSTER = "https://api.open5e.com/monsters/?search=";
        const API_SPELL = "https://api.open5e.com/spells/?search=";

        // --- NAVIGATION ---
        function nav(id) {
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            
            const map = {'tab-actions':'nav-act', 'tab-pj':'nav-pj', 'tab-monstre':'nav-mon', 'tab-simu':'nav-sim'};
            document.getElementById(map[id]).classList.add('active');

            if(id==='tab-actions') loadActs();
            if(id==='tab-pj') { renderStats('pj'); loadChk('pj_act_chk'); loadList('PJ','list-pj'); }
            if(id==='tab-monstre') { renderStats('m'); loadChk('m_act_chk'); loadList('MONSTRE','list-m'); }
            if(id==='tab-simu') loadSimChk();
        }

        function toggleSearch(id) { document.getElementById(id).classList.toggle('hidden'); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- INTEGRATION OPEN5E ---
        
        // 1. Sorts
        async function searchSpells() {
            const q = document.getElementById('spell_query').value;
            if(!q) return;
            const res = await fetch(API_SPELL + q);
            const data = await res.json();
            const div = document.getElementById('spell_results');
            div.classList.remove('hidden');
            div.innerHTML = data.results.slice(0, 10).map(s => 
                `<div onclick='importSpell(${JSON.stringify(s).replace(/'/g, "&#39;")})' class="search-result">${s.name} (Lvl ${s.level_int})</div>`
            ).join('');
        }

        function importSpell(s) {
            document.getElementById('act_nom').value = s.name;
            document.getElementById('act_lvl').value = s.level_int || 0;
            // Extraction Regex pour les d√©g√¢ts (ex: "8d6")
            const dmgMatch = s.desc.match(/(\d+d\d+(\s*\+\s*\d+)?)/);
            document.getElementById('act_dice').value = dmgMatch ? dmgMatch[0] : "";
            
            // Deviner le type
            let type = "attaque";
            let save = null;
            if(s.desc.toLowerCase().includes("saving throw")) {
                type = "save";
                if(s.desc.includes("Dexterity")) save = "dex";
                else if(s.desc.includes("Constitution")) save = "con";
                else if(s.desc.includes("Wisdom")) save = "wis";
                else if(s.desc.includes("Strength")) save = "str";
            }
            if(s.desc.toLowerCase().includes("regain hit points")) type = "soin";

            document.getElementById('act_type').value = type;
            if(save) document.getElementById('act_save').value = save;
            
            uiEff();
            document.getElementById('spell_results').classList.add('hidden');
            toggleSearch('spell_search_box');
            showToast("Donn√©es du sort charg√©es");
        }

        // 2. Monstres
        async function searchMonster() {
            const q = document.getElementById('mon_query').value;
            if(!q) return;
            const res = await fetch(API_MONSTER + q);
            const data = await res.json();
            const div = document.getElementById('mon_results');
            div.classList.remove('hidden');
            div.innerHTML = data.results.slice(0, 10).map(m => 
                `<div onclick='importMonster(${JSON.stringify(m).replace(/'/g, "&#39;")})' class="search-result">${m.name} (CR ${m.challenge_rating})</div>`
            ).join('');
        }

        async function importMonster(m) {
            document.getElementById('m_nom').value = m.name;
            document.getElementById('m_lvl').value = m.challenge_rating;
            document.getElementById('m_hp').value = m.hit_points;
            document.getElementById('m_ac').value = m.armor_class;
            // Stats
            document.getElementById('m_str').value = m.strength;
            document.getElementById('m_dex').value = m.dexterity;
            document.getElementById('m_con').value = m.constitution;
            document.getElementById('m_int').value = m.intelligence;
            document.getElementById('m_wis').value = m.wisdom;
            document.getElementById('m_cha').value = m.charisma;

            // Import Actions auto
            if(m.actions) {
                for(let act of m.actions) {
                    const dmgMatch = act.desc.match(/(\d+d\d+(\s*\+\s*\d+)?)/);
                    if(dmgMatch) {
                        // On cr√©e l'action en DB
                        const payload = {
                            nom: `${act.name} (${m.name})`,
                            formule: dmgMatch[0],
                            type_action: "attaque",
                            level: 0,
                            save_stat: null,
                            effect_json: null
                        };
                        await fetch('/api/action/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                    }
                }
                showToast("Actions du monstre import√©es !");
                await loadChk('m_act_chk'); // Rafraichir la liste
            }

            document.getElementById('mon_results').classList.add('hidden');
            toggleSearch('mon_search_box');
        }

        // --- LOGIQUE UI STANDARD ---
        function resetForm(p) {
            document.getElementById(p+'_id').value = "";
            const btn = document.getElementById('btn_save_'+p);
            btn.innerText = p==='act'?"Inscrire le Sort":(p==='pj'?"Enr√¥ler":"Invoquer");
            btn.classList.remove('bg-yellow-700');
            document.getElementById('btn_cancel_'+p).classList.add('hidden');
            document.querySelectorAll(`#tab-${p==='act'?'actions':(p==='pj'?'pj':'monstre')} input`).forEach(i => i.type!=='checkbox'?i.value='':i.checked=false);
            if(p!=='act') renderStats(p);
        }

        function editMode(p) {
            const btn = document.getElementById('btn_save_'+p);
            btn.innerText = "Modifier";
            btn.classList.add('bg-yellow-700');
            document.getElementById('btn_cancel_'+p).classList.remove('hidden');
        }

        function uiEff() {
            document.getElementById('save_ui').classList.toggle('hidden', document.getElementById('act_type').value!=='save');
            document.getElementById('eff_ui').classList.toggle('hidden', !document.getElementById('has_eff').checked);
        }
        
        function renderStats(p) {
            const d=document.getElementById(p+'_stats'); if(d.innerHTML.trim()!=='')return;
            STATS.forEach(s=>d.innerHTML+=`<div class="text-center"><label class="text-[9px] text-gray-500 font-bold uppercase block mb-1">${s}</label><input type="number" id="${p}_${s}" value="10" class="w-full bg-[#111] border border-gray-700 rounded text-center text-sm text-white focus:border-dnd-gold outline-none py-1"></div>`);
        }

        // --- API CALLS ACTIONS ---
        async function saveAct() {
            let eff=null; 
            if(document.getElementById('has_eff').checked) eff=JSON.stringify({type:document.getElementById('eff_type').value, target:document.getElementById('eff_tgt').value, val:document.getElementById('eff_val').value, duration:parseInt(document.getElementById('eff_dur').value)||10, conc:document.getElementById('eff_conc').checked});
            const d = {
                id: document.getElementById('act_id').value || null,
                nom: document.getElementById('act_nom').value, formule: document.getElementById('act_dice').value,
                type_action: document.getElementById('act_type').value, level: parseInt(document.getElementById('act_lvl').value)||0,
                save_stat: document.getElementById('act_save').value, effect_json: eff,
                mastery: document.getElementById('act_mastery').value || null
            };
            await fetch('/api/action/save', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            resetForm('act'); showToast("Action enregistr√©e"); loadActs();
        }

        async function loadActs() {
            const d = await (await fetch('/api/action/list')).json();
            document.getElementById('list-act').innerHTML = d.map(a => `
                <div onclick='editAct(${JSON.stringify(a)})' class="rpg-panel p-3 cursor-pointer hover:bg-white/5 transition group">
                    <div class="flex justify-between">
                        <div class="font-bold text-dnd-gold group-hover:text-white">${a.nom}</div>
                        <div class="text-[10px] bg-gray-800 px-2 rounded text-gray-400 border border-gray-600">Niv ${a.level}</div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${a.type_action} ‚Ä¢ ${a.formule_degats}</div>
                </div>`).join('');
        }

        function editAct(a) {
            document.getElementById('act_id').value = a.id;
            document.getElementById('act_nom').value = a.nom;
            document.getElementById('act_dice').value = a.formule_degats;
            document.getElementById('act_lvl').value = a.level;
            document.getElementById('act_type').value = a.type_action;
            if(a.save_stat) document.getElementById('act_save').value = a.save_stat;
            // Charger la ma√Ætrise si pr√©sente
            try { document.getElementById('act_mastery').value = a.mastery || ""; } catch(e){}
            const eff = a.effect_json ? JSON.parse(a.effect_json) : null;
            document.getElementById('has_eff').checked = !!eff;
            if(eff) { document.getElementById('eff_type').value=eff.type; document.getElementById('eff_val').value=eff.val; }
            uiEff(); editMode('act');
        }

        // --- API CALLS FIGHTERS ---
        async function saveF(type) {
            const p = type==='PJ'?'pj':'m';
            const s={}; STATS.forEach(k=>s[k]=parseInt(document.getElementById(`${p}_${k}`).value)||10);
            const acts=Array.from(document.getElementById(`${p}_act_chk`).querySelectorAll('input:checked')).map(c=>parseInt(c.value));
            const feats=p==='pj'?Array.from(document.querySelectorAll('.pj-feat:checked')).map(c=>c.value):[];
            const d = {
                id: document.getElementById(p+'_id').value || null,
                nom: document.getElementById(p+'_nom').value, type_entite:type, classe: type==='PJ'?document.getElementById('pj_cls').value:'Monstre',
                niveau: parseInt(document.getElementById(p==='pj'?'pj_lvl':'m_lvl').value)||1, stats:s, hp_max:parseInt(document.getElementById(p+'_hp').value)||10, ac:parseInt(document.getElementById(p+'_ac').value)||10,
                actions_ids: acts, features: feats, position: document.getElementById(p+'_pos').value, behavior: p==='m'?document.getElementById('m_beh').value:'random'
            };
            await fetch('/api/fighter/save', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            resetForm(p); showToast(type+" Sauvegard√©"); loadList(type, type==='PJ'?'list-pj':'list-m');
        }

        async function loadList(type, target) {
            const d = await (await fetch(`/api/fighter/list?type=${type}`)).json();
            const p = type==='PJ'?'pj':'m';
            document.getElementById(target).innerHTML = d.map(f => `
                <div onclick='editF(${JSON.stringify(f)}, "${p}")' class="rpg-panel p-4 cursor-pointer hover:bg-white/5 transition group relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full ${type==='PJ'?'bg-dnd-blue':'bg-dnd-red'}"></div>
                    <div class="ml-2">
                        <div class="font-fantasy text-lg ${type==='PJ'?'text-blue-300':'text-red-300'} group-hover:text-white">${f.nom}</div>
                        <div class="text-xs text-gray-500 uppercase mt-1 flex gap-2 items-center">
                            <span class="bg-black/30 px-1 rounded">Niv ${f.niveau}</span>
                            <span class="text-${type==='PJ'?'green':'orange'}-500 font-bold">HP ${f.hp_max}</span>
                            <span class="text-gray-400">AC ${f.ac}</span>
                        </div>
                    </div>
                    <i class="fas fa-pen absolute top-4 right-4 text-gray-700 group-hover:text-dnd-gold transition-colors"></i>
                </div>`).join('');
        }

        function editF(f, p) {
            document.getElementById(p+'_id').value = f.id; document.getElementById(p+'_nom').value = f.nom;
            if(p==='pj') { document.getElementById('pj_cls').value = f.classe; document.getElementById('pj_lvl').value = f.niveau; } else { document.getElementById('m_lvl').value = f.niveau; }
            document.getElementById(p+'_hp').value = f.hp_max; document.getElementById(p+'_ac').value = f.ac; document.getElementById(p+'_pos').value = f.position;
            STATS.forEach(k => document.getElementById(`${p}_${k}`).value = f.stats[k]);
            document.querySelectorAll(`#${p}_act_chk input`).forEach(i => i.checked = false);
            if(f.actions_ids) JSON.parse(f.actions_ids).forEach(id => { const el = document.querySelector(`#${p}_act_chk input[value="${id}"]`); if(el) el.checked = true; });
            if(p==='pj') { document.querySelectorAll('.pj-feat').forEach(i => i.checked = false); if(f.features) JSON.parse(f.features).forEach(ft => { const el = document.querySelector(`.pj-feat[value="${ft}"]`); if(el) el.checked = true; }); }
            editMode(p);
        }

        async function loadChk(id) {
            const d = await (await fetch('/api/action/list')).json();
            document.getElementById(id).innerHTML = d.map(a => `
                <label class="flex items-center p-2 hover:bg-white/5 rounded cursor-pointer transition-colors border-b border-gray-800/50">
                    <input type="checkbox" value="${a.id}" class="form-checkbox text-dnd-gold bg-black border-gray-600 rounded h-3 w-3 mr-2 focus:ring-0">
                    <div class="flex flex-col"><span class="text-xs font-bold text-gray-300">${a.nom}</span><span class="text-[9px] text-gray-600">${a.formule_degats}</span></div>
                </label>`).join('');
        }

        async function loadSimChk() {
            // Chargement des PJ (On garde la logique simple pour eux, g√©n√©ralement uniques)
            let d = await (await fetch('/api/fighter/list?type=PJ')).json();
            document.getElementById('sim_pj').innerHTML = d.map(f => `
                <label class="flex items-center p-3 bg-black/30 border border-gray-800 rounded mb-2 hover:border-dnd-blue cursor-pointer transition-all">
                    <input type="checkbox" value="${f.id}" class="mr-3 text-dnd-blue bg-black border-gray-600 rounded focus:ring-0">
                    <span class="text-sm font-bold text-blue-200">${f.nom}</span>
                </label>`).join('');

            // Chargement des Monstres (AVEC QUANTIT√â)
            d = await (await fetch('/api/fighter/list?type=MONSTRE')).json();
            document.getElementById('sim_m').innerHTML = d.map(f => `
                <div class="flex items-center p-3 bg-black/30 border border-gray-800 rounded mb-2 hover:border-dnd-red transition-all">
                    <label class="flex items-center flex-1 cursor-pointer">
                        <input type="checkbox" value="${f.id}" class="mon-check mr-3 text-dnd-red bg-black border-gray-600 rounded focus:ring-0">
                        <span class="text-sm font-bold text-red-200">${f.nom}</span>
                    </label>
                    <input type="number" min="1" value="1" class="mon-qty w-16 bg-[#0b0c10] border border-gray-700 rounded text-center text-white text-sm p-1 focus:border-dnd-red outline-none" onclick="event.stopPropagation()">
                    <span class="text-xs text-gray-500 ml-2">Qt√©</span>
                </div>`).join('');
        }

        async function runSim() {
            const btn = document.querySelector('button[onclick="runSim()"]'); 
            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Simulation en cours...';
            // R√©cup√©ration des IDs PJ (Simple)
            const p = Array.from(document.getElementById('sim_pj').querySelectorAll('input:checked')).map(c=>parseInt(c.value));
            // R√©cup√©ration des IDs Monstres (Avec boucle de quantit√©)
            const m = [];
            document.querySelectorAll('#sim_m .mon-check:checked').forEach(chk => {
                const id = parseInt(chk.value);
                // On cherche l'input de quantit√© qui est dans le m√™me conteneur parent
                const qtyInput = chk.closest('div').querySelector('.mon-qty');
                const qty = parseInt(qtyInput.value) || 1;
                // On ajoute l'ID autant de fois que la quantit√© demand√©e
                for(let i=0; i < qty; i++) {
                    m.push(id);
                }
            });
            try {
                const r = await (await fetch('/api/simulate', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({
                        iterations:parseInt(document.getElementById('iter').value), 
                        pj_ids:p, 
                        monstre_ids:m
                    })
                })).json();
                // ... Reste du code inchang√© pour l'affichage ...
                document.getElementById('res_panel').classList.remove('hidden'); 
                document.getElementById('res_win').innerText = r.win_rate.toFixed(1) + '%';
                document.getElementById('log_area').innerHTML = r.sample_log.map(l => `<div class="py-1 border-b border-gray-800/50 hover:bg-white/5 px-2">${l}</div>`).join('');
                const ctx = document.getElementById('dmgChart').getContext('2d'); 
                if(myChart) myChart.destroy();
                myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(r.dmg_distribution), datasets: [{ data: Object.values(r.dmg_distribution), backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6'], borderWidth: 0 }] }, options: { plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false } });
                showToast("Simulation Termin√©e");
            } catch(e) { 
                showToast("Erreur lors du calcul"); 
                console.error(e); 
            }
            btn.disabled = false; 
            btn.innerHTML = 'COMBATTRE !';
        }
        
        nav('tab-actions');
    </script>
</body>
</html>