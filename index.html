<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D&D Tactician - Editor Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Scroll */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 font-sans h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col z-20 shadow-2xl">
        <div class="p-6 text-center border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white"><i class="fas fa-dragon text-purple-500 mr-2"></i>Tactician</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="nav('tab-actions')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-700 text-gray-400 transition"><i class="fas fa-scroll mr-3"></i> Grimoire</button>
            <button onclick="nav('tab-pj')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-700 text-gray-400 transition"><i class="fas fa-user-shield mr-3"></i> Héros</button>
            <button onclick="nav('tab-monstre')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-700 text-gray-400 transition"><i class="fas fa-skull mr-3"></i> Monstres</button>
            <button onclick="nav('tab-simu')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-gray-700 text-gray-400 transition"><i class="fas fa-chart-pie mr-3"></i> Simulation</button>
        </nav>
    </div>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-8 relative">
        
        <!-- TAB: ACTIONS -->
        <div id="tab-actions" class="content hidden fade-in">
            <h2 class="text-2xl font-bold text-purple-400 mb-6">Éditeur de Sorts & Armes</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- FORM -->
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl border border-gray-700 h-fit sticky top-4">
                    <input type="hidden" id="act_id"> <!-- ID CACHÉ POUR UPDATE -->
                    
                    <div class="space-y-4">
                        <div><label class="lbl">Nom</label><input id="act_nom" class="inp" placeholder="Ex: Épée longue"></div>
                        <div class="flex gap-2">
                            <div class="w-1/3"><label class="lbl">Niveau</label><input type="number" id="act_lvl" value="0" class="inp text-center"></div>
                            <div class="w-2/3"><label class="lbl">Dégâts</label><input id="act_dice" class="inp" placeholder="1d8"></div>
                        </div>
                        <div><label class="lbl">Type</label>
                            <select id="act_type" onchange="uiEff()" class="inp"><option value="attaque">Attaque</option><option value="save">Sauvegarde</option><option value="soin">Soin / Buff</option></select>
                        </div>
                        
                        <div id="save_ui" class="hidden bg-gray-900 p-3 rounded border border-gray-600">
                            <label class="lbl text-blue-400">Stat de Save</label>
                            <select id="act_save" class="inp"><option value="dex">DEX</option><option value="con">CON</option><option value="wis">WIS</option></select>
                        </div>

                        <div><label class="flex items-center cursor-pointer"><input type="checkbox" id="has_eff" onchange="uiEff()" class="mr-2"> Ajouter Effet</label></div>
                        <div id="eff_ui" class="hidden bg-gray-900 p-3 rounded border border-gray-600 space-y-2">
                            <select id="eff_type" class="inp"><option value="buff_atk">Buff Atk</option><option value="buff_ac">Buff CA</option><option value="prone">Debuff: À terre</option></select>
                            <select id="eff_tgt" class="inp"><option value="self">Sur Soi</option><option value="enemy">Sur Ennemi</option></select>
                            <div class="flex gap-2"><input id="eff_val" placeholder="Val" class="inp"><input id="eff_dur" value="10" class="inp"></div>
                            <label class="flex items-center text-xs"><input type="checkbox" id="eff_conc" class="mr-1"> Concentration</label>
                        </div>
                        
                        <div class="flex gap-2 pt-2">
                            <button id="btn_cancel_act" onclick="resetForm('act')" class="hidden w-1/3 bg-gray-600 hover:bg-gray-500 text-white rounded py-2">Annuler</button>
                            <button id="btn_save_act" onclick="saveAct()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded transition">Créer</button>
                        </div>
                    </div>
                </div>

                <!-- LIST -->
                <div class="lg:col-span-2">
                    <p class="text-xs text-gray-500 mb-2 uppercase font-bold">Cliquez sur une carte pour modifier</p>
                    <div id="list-act" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- TAB: PJ -->
        <div id="tab-pj" class="content hidden fade-in">
            <h2 class="text-2xl font-bold text-blue-400 mb-6">Éditeur de Héros</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl border border-gray-700 h-fit sticky top-4">
                    <input type="hidden" id="pj_id">
                    <div class="space-y-3">
                        <input id="pj_nom" class="inp font-bold text-lg" placeholder="Nom du Héros">
                        <div class="flex gap-2"><select id="pj_cls" class="inp"><option value="Guerrier">Guerrier</option><option value="Mage">Mage</option><option value="Paladin">Paladin</option></select><input type="number" id="pj_lvl" value="5" class="inp w-16 text-center"></div>
                        <select id="pj_pos" class="inp"><option value="front">Frontline (CaC)</option><option value="back">Backline (Dist)</option></select>
                        
                        <div class="grid grid-cols-6 gap-1 bg-gray-900 p-2 rounded border border-gray-600" id="pj_stats"></div>
                        
                        <div class="border-t border-gray-700 pt-3">
                            <p class="lbl mb-1">Dons</p>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label><input type="checkbox" class="pj-feat mr-1" value="Great Weapon Master"> GWM</label>
                                <label><input type="checkbox" class="pj-feat mr-1" value="Sharpshooter"> Sharp</label>
                                <label><input type="checkbox" class="pj-feat mr-1" value="War Caster"> WarCast</label>
                            </div>
                        </div>
                        
                        <div class="h-32 overflow-y-auto bg-gray-900 p-2 rounded border border-gray-600"><div id="pj_act_chk" class="space-y-1"></div></div>
                        <div class="flex gap-2"><input id="pj_hp" placeholder="PV" class="inp"><input id="pj_ac" placeholder="AC" class="inp"></div>
                        
                        <div class="flex gap-2 pt-2">
                            <button id="btn_cancel_pj" onclick="resetForm('pj')" class="hidden w-1/3 bg-gray-600 text-white rounded py-2">Annuler</button>
                            <button id="btn_save_pj" onclick="saveF('PJ')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">Sauvegarder</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2" id="list-pj"></div>
            </div>
        </div>

        <!-- TAB: MONSTRE -->
        <div id="tab-monstre" class="content hidden fade-in">
            <h2 class="text-2xl font-bold text-red-400 mb-6">Bestiaire</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl border border-gray-700 h-fit sticky top-4">
                    <input type="hidden" id="m_id">
                    <div class="space-y-3">
                        <input id="m_nom" class="inp font-bold text-lg" placeholder="Nom Monstre">
                        <div class="flex gap-2"><input id="m_lvl" class="inp" placeholder="CR"><select id="m_beh" class="inp"><option value="random">Random</option><option value="focus_low_hp">Tueur</option></select></div>
                        <select id="m_pos" class="inp"><option value="front">Frontline</option><option value="back">Backline</option></select>
                        <div class="grid grid-cols-6 gap-1 bg-gray-900 p-2 rounded" id="m_stats"></div>
                        <div class="h-32 overflow-y-auto bg-gray-900 p-2 rounded"><div id="m_act_chk"></div></div>
                        <div class="flex gap-2"><input id="m_hp" placeholder="PV" class="inp"><input id="m_ac" placeholder="AC" class="inp"></div>
                        <div class="flex gap-2 pt-2">
                            <button id="btn_cancel_m" onclick="resetForm('m')" class="hidden w-1/3 bg-gray-600 text-white rounded">Annuler</button>
                            <button id="btn_save_m" onclick="saveF('MONSTRE')" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded">Sauvegarder</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2" id="list-m"></div>
            </div>
        </div>

        <!-- TAB: SIMU -->
        <div id="tab-simu" class="content hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex flex-col">
                    <h3 class="text-blue-400 font-bold mb-2">Héros</h3><div id="sim_pj" class="flex-1 overflow-y-auto bg-gray-900 p-2 rounded mb-4"></div>
                    <h3 class="text-red-400 font-bold mb-2">Monstres</h3><div id="sim_m" class="flex-1 overflow-y-auto bg-gray-900 p-2 rounded mb-4"></div>
                    <button onclick="runSim()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded">LANCER LA SIMULATION</button>
                </div>
                <div class="col-span-2 flex flex-col gap-4">
                    <div id="res_panel" class="hidden bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center">
                        <div class="text-center"><p class="text-gray-400 text-xs uppercase">Victoire</p><h1 id="res_win" class="text-5xl font-black text-blue-500">--%</h1></div>
                        <div class="h-32 w-32"><canvas id="dmgChart"></canvas></div>
                    </div>
                    <div class="flex-1 bg-black p-4 rounded border border-gray-700 font-mono text-sm text-green-400 overflow-y-auto" id="log_area"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STATS = ['str','dex','con','int','wis','cha']; let myChart = null;
        
        // --- UI HELPERS ---
        function nav(id) {
            document.querySelectorAll('.content').forEach(c=>c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.replace('bg-gray-700','hover:bg-gray-700')); 
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('text-white'));
            event.currentTarget.classList.add('bg-gray-700','text-white');
            if(id==='tab-actions') loadActs();
            if(id==='tab-pj') { renderStats('pj'); loadChk('pj_act_chk'); loadList('PJ','list-pj'); }
            if(id==='tab-monstre') { renderStats('m'); loadChk('m_act_chk'); loadList('MONSTRE','list-m'); }
            if(id==='tab-simu') loadSimChk();
        }

        function resetForm(p) {
            document.getElementById(p+'_id').value = "";
            const btnSave = document.getElementById('btn_save_'+p);
            btnSave.innerText = p==='act'?"Créer":"Sauvegarder";
            btnSave.classList.remove('bg-yellow-600','hover:bg-yellow-500');
            btnSave.classList.add(p==='act'?'bg-purple-600':(p==='pj'?'bg-blue-600':'bg-red-600'));
            document.getElementById('btn_cancel_'+p).classList.add('hidden');
            // Clear inputs (basic)
            document.querySelectorAll(`#tab-${p==='act'?'actions':(p==='pj'?'pj':'monstre')} input`).forEach(i=>i.type!=='checkbox'?i.value='':i.checked=false);
            if(p!=='act') renderStats(p); // Reset stats to 10
        }

        function editMode(p) {
            const btnSave = document.getElementById('btn_save_'+p);
            btnSave.innerText = "Modifier";
            btnSave.classList.remove('bg-purple-600','bg-blue-600','bg-red-600');
            btnSave.classList.add('bg-yellow-600','hover:bg-yellow-500');
            document.getElementById('btn_cancel_'+p).classList.remove('hidden');
        }

        function uiEff() {
            document.getElementById('save_ui').classList.toggle('hidden', document.getElementById('act_type').value!=='save');
            document.getElementById('eff_ui').classList.toggle('hidden', !document.getElementById('has_eff').checked);
        }
        function renderStats(p) {
            const d=document.getElementById(p+'_stats'); if(d.innerHTML.trim()!=='')return;
            STATS.forEach(s=>d.innerHTML+=`<div class="text-center"><label class="text-[10px] text-gray-500 font-bold uppercase">${s}</label><input type="number" id="${p}_${s}" value="10" class="w-full bg-gray-800 border border-gray-600 rounded text-center text-sm text-white"></div>`);
        }

        // --- ACTIONS ---
        async function saveAct() {
            let eff=null; 
            if(document.getElementById('has_eff').checked) eff=JSON.stringify({type:document.getElementById('eff_type').value, target:document.getElementById('eff_tgt').value, val:document.getElementById('eff_val').value, duration:parseInt(document.getElementById('eff_dur').value)||10, conc:document.getElementById('eff_conc').checked});
            const d = {
                id: document.getElementById('act_id').value || null,
                nom: document.getElementById('act_nom').value, formule: document.getElementById('act_dice').value,
                type_action: document.getElementById('act_type').value, level: parseInt(document.getElementById('act_lvl').value)||0,
                save_stat: document.getElementById('act_save').value, effect_json: eff
            };
            await fetch('/api/action/save', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            resetForm('act'); loadActs();
        }
        
        async function loadActs() {
            const d = await (await fetch('/api/action/list')).json();
            document.getElementById('list-act').innerHTML = d.map(a => `
                <div onclick='editAct(${JSON.stringify(a)})' class="bg-gray-800 p-3 rounded border-l-4 ${a.level>0?'border-purple-500':'border-gray-500'} cursor-pointer hover:bg-gray-700 transition">
                    <div class="font-bold text-sm text-white">${a.nom}</div>
                    <div class="text-xs text-gray-400">${a.type_action} • Niv ${a.level}</div>
                </div>`).join('');
        }

        function editAct(a) {
            document.getElementById('act_id').value = a.id;
            document.getElementById('act_nom').value = a.nom;
            document.getElementById('act_dice').value = a.formule_degats;
            document.getElementById('act_lvl').value = a.level;
            document.getElementById('act_type').value = a.type_action;
            document.getElementById('act_save').value = a.save_stat || 'dex';
            
            const eff = a.effect_json ? JSON.parse(a.effect_json) : null;
            document.getElementById('has_eff').checked = !!eff;
            if(eff) {
                document.getElementById('eff_type').value = eff.type;
                document.getElementById('eff_tgt').value = eff.target;
                document.getElementById('eff_val').value = eff.val;
                document.getElementById('eff_dur').value = eff.duration;
                document.getElementById('eff_conc').checked = eff.conc;
            }
            uiEff(); editMode('act');
        }

        // --- FIGHTERS ---
        async function saveF(type) {
            const p = type==='PJ'?'pj':'m';
            const s={}; STATS.forEach(k=>s[k]=parseInt(document.getElementById(`${p}_${k}`).value)||10);
            const acts=Array.from(document.getElementById(`${p}_act_chk`).querySelectorAll('input:checked')).map(c=>parseInt(c.value));
            const feats=p==='pj'?Array.from(document.querySelectorAll('.pj-feat:checked')).map(c=>c.value):[];
            const d = {
                id: document.getElementById(p+'_id').value || null,
                nom: document.getElementById(p+'_nom').value, type_entite:type, classe: type==='PJ'?document.getElementById('pj_cls').value:'Monstre',
                niveau: parseInt(document.getElementById(p==='pj'?'pj_lvl':'m_lvl').value)||1, stats:s, hp_max:parseInt(document.getElementById(p+'_hp').value)||10, ac:parseInt(document.getElementById(p+'_ac').value)||10,
                actions_ids: acts, features: feats, position: document.getElementById(p+'_pos').value, behavior: p==='m'?document.getElementById('m_beh').value:'random'
            };
            await fetch('/api/fighter/save', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
            resetForm(p); loadList(type, type==='PJ'?'list-pj':'list-m');
        }

        async function loadList(type, target) {
            const d = await (await fetch(`/api/fighter/list?type=${type}`)).json();
            const p = type==='PJ'?'pj':'m';
            document.getElementById(target).innerHTML = d.map(f => `
                <div class="bg-gray-800 p-3 rounded border border-gray-700 hover:border-${type==='PJ'?'blue':'red'}-500 cursor-pointer transition group relative" onclick='editF(${JSON.stringify(f)}, "${p}")'>
                    <div class="font-bold text-${type==='PJ'?'blue':'red'}-400">${f.nom}</div>
                    <div class="text-xs text-gray-400">Lvl ${f.niveau} ${f.classe}</div>
                    <div class="absolute top-2 right-2 text-[10px] bg-gray-900 px-1 rounded border border-gray-600 text-gray-400 group-hover:text-white">EDIT</div>
                </div>
            `).join('');
        }
        
        function editF(f, p) {
            document.getElementById(p+'_id').value = f.id;
            document.getElementById(p+'_nom').value = f.nom;
            if(p==='pj') { document.getElementById('pj_cls').value = f.classe; document.getElementById('pj_lvl').value = f.niveau; }
            else { document.getElementById('m_lvl').value = f.niveau; document.getElementById('m_beh').value = f.behavior; }
            
            document.getElementById(p+'_hp').value = f.hp_max;
            document.getElementById(p+'_ac').value = f.ac;
            document.getElementById(p+'_pos').value = f.position;
            
            STATS.forEach(k => document.getElementById(`${p}_${k}`).value = f.stats[k]);
            
            // Reset checks
            document.querySelectorAll(`#${p}_act_chk input`).forEach(i => i.checked = false);
            if(f.actions_ids) JSON.parse(f.actions_ids).forEach(id => {
                const el = document.querySelector(`#${p}_act_chk input[value="${id}"]`);
                if(el) el.checked = true;
            });

            if(p==='pj') {
                document.querySelectorAll('.pj-feat').forEach(i => i.checked = false);
                if(f.features) JSON.parse(f.features).forEach(feat => {
                    const el = document.querySelector(`.pj-feat[value="${feat}"]`);
                    if(el) el.checked = true;
                });
            }
            editMode(p);
        }

        async function loadChk(id) {
            const d = await (await fetch('/api/action/list')).json();
            document.getElementById(id).innerHTML = d.map(a => `<label class="flex items-center p-1 hover:bg-gray-700 rounded cursor-pointer"><input type="checkbox" value="${a.id}" class="mr-2 rounded bg-gray-900 border-gray-600"><span class="text-xs text-gray-300">${a.nom}</span></label>`).join('');
        }

        async function loadSimChk() {
            let d = await (await fetch('/api/fighter/list?type=PJ')).json();
            document.getElementById('sim_pj').innerHTML = d.map(f=>`<label class="flex items-center p-2 bg-gray-800 rounded mb-1 hover:bg-gray-700 cursor-pointer"><input type="checkbox" value="${f.id}" class="mr-2"><span class="text-sm font-bold text-blue-300">${f.nom}</span></label>`).join('');
            d = await (await fetch('/api/fighter/list?type=MONSTRE')).json();
            document.getElementById('sim_m').innerHTML = d.map(f=>`<label class="flex items-center p-2 bg-gray-800 rounded mb-1 hover:bg-gray-700 cursor-pointer"><input type="checkbox" value="${f.id}" class="mr-2"><span class="text-sm font-bold text-red-300">${f.nom}</span></label>`).join('');
        }

        async function runSim() {
            const p = Array.from(document.getElementById('sim_pj').querySelectorAll('input:checked')).map(c=>parseInt(c.value));
            const m = Array.from(document.getElementById('sim_m').querySelectorAll('input:checked')).map(c=>parseInt(c.value));
            const r = await (await fetch('/api/simulate', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({iterations:parseInt(document.getElementById('iter').value), pj_ids:p, monstre_ids:m})})).json();
            document.getElementById('res_panel').classList.remove('hidden');
            document.getElementById('res_win').innerText = r.win_rate.toFixed(1)+'%';
            document.getElementById('log_area').innerHTML = r.sample_log.map(l=>`<div class="py-1 border-b border-gray-800 text-gray-300">${l}</div>`).join('');
            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('dmgChart'), { type:'doughnut', data:{labels:Object.keys(r.dmg_distribution), datasets:[{data:Object.values(r.dmg_distribution), backgroundColor:['#3b82f6','#ef4444','#10b981','#f59e0b'], borderWidth:0}]}, options:{plugins:{legend:{display:false}},responsive:true,maintainAspectRatio:false}});
        }

        // Styles
        const style = document.createElement('style');
        style.textContent = `.lbl{display:block;font-size:0.7rem;color:#9ca3af;font-weight:700;text-transform:uppercase;margin-bottom:2px;} .inp{width:100%;background:#111827;border:1px solid #374151;color:white;padding:6px;border-radius:4px;font-size:0.9rem;outline:none;} .inp:focus{border-color:#60a5fa;}`;
        document.head.appendChild(style);
        nav('tab-actions');
    </script>
</body>
</html>